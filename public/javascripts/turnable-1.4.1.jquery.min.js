/*
    turnable  - a jQuery 360 image-enhancer
    Copyright (c) 2013 Moving Stills AB
    Forbidden to use or spread for any purposes if you haven't bought the product from Moving Stills AB
    version: 1.4.1
    Dependent on jQuery
*/(function(e){var t=function(t,n){this.elem=t;this.$elem=e(t);this.options=n;this.metadata=this.$elem.data("turnable-options")};t.prototype={touchDevice:!1,$zoomLens:null,$wrapper:null,$elem:null,startDragPosition:0,dragDistance:0,currentImage:0,defaults:{catwalk:!1,cursor:"col-resize",dragThreshold:10,frames:38,imageExt:".jpg",images:[],showSpinButton:!0,wrapAround:!0,singleImage:!1,showInstruction:!0,instructionContent:"<p> &lt; Swipe to spin &gt; </p>",spinButtonContent:"spin",zoomButtonContent:"zoom",nextButtonContent:"next",previousButtonContent:"previous",step:!1,spinSpeed:1500,zoom:!1,zoomAsLink:!1,zoomSuffix:"_big",zoomImages:[],onComplete:function(){}},init:function(){this.config=e.extend({},this.defaults,this.options,this.metadata);console.log(this.config);this.config.images.length>0&&(this.config.frames=this.config.images.length);this._readPropertiesFromClasses();this._checkForTouchDevice();this._createWrapper();this._initEvents();this._loadImages();return this},events:{"click .turnable-spin-button":"_spinButtonClicked","click .turnable-step-previous-button":"_previousButtonClicked","click .turnable-step-next-button":"_nextButtonClicked","click .turnable-zoom-button":"_zoomButtonClicked","click .turnable-zoom-lens":"_zoomLensClicked","touchstart img":"_imageTouched",mouseenter:"_entering",mouseleave:"_leaving",mousedown:"_dragStarted","mousemove document":"_dragging",mousemove:"_moving",touchstart:"_dragStarted","touchmove document":"_dragging",touchend:"_dragEnded","mouseup document":"_dragEnded"},internalEvents:{allImagesLoaded:"_allImagesLoaded"},_initEvents:function(){var t=this;this.touchDevice="ontouchstart"in document.documentElement;e.each(this.internalEvents,function(n,r){e(t).on(n,e.proxy(t,r))});e.each(this.events,function(n,r){var i=n.split(" "),s=i[0];if(i.length>1){var o=i[1];o==="document"?e(document).on(s,e.proxy(t,r)):t.$wrapper.on(s,o,e.proxy(t,r))}else t.$wrapper.on(s,e.proxy(t,r))})},_readPropertiesFromClasses:function(){var e=this.$elem.attr("class");if(e){var t=e.match(/frames=(\d[\d]*)/g);if(t){var n=String(t),r=n.match(/(\d[\d]*)/g);r&&(this.config.frames=parseInt(n.match(/(\d[\d]*)/g)))}}this.$elem.hasClass("zoom")&&(this.config.zoom=!0);if(this.$elem.hasClass("moving-still")||this.$elem.hasClass("nowrap"))this.config.wrapAround=!1;if(this.$elem.hasClass("catwalk")){this.config.catwalk=!0;this.config.spinSpeed=3e3}this.$elem.hasClass("nospin")&&(this.config.showSpinButton=!1)},_checkForTouchDevice:function(){"ontouchstart"in window&&(this.touchDevice=!0)},_createWrapper:function(){if(this.$elem.is("img")){var t=e("<div></div>").attr("class","turnable-wrapper");t.css({width:this.$elem.width(),height:this.$elem.height(),cursor:this.config.cursor});this.$elem.wrap(t);this.$wrapper=this.$elem.parent(".turnable-wrapper")}else{this.$wrapper=this.$elem.addClass("turnable-wrapper");if(this.config.images.length>0){this.$elem=e("<img/>");this.$wrapper.append(this.$elem);var n=this;this.$elem.on("load",function(){n.$wrapper.css({width:n.$elem.width(),height:n.$elem.height(),cursor:n.config.cursor})});this.$elem.attr("src",this.config.images[0])}}},_loadImages:function(){if(!this.config.singleImage){this.imageLoaded=0;if(this.$elem.is("img")){this._startPreloader();var t=this.$elem.attr("src"),n=t.substr(0,t.lastIndexOf("-")+1);for(var r=0;r<this.config.frames;r+=1){r<9?this.config.images.push(n+"0"+(r+1).toString()+this.config.imageExt):this.config.images.push(n+(r+1).toString()+this.config.imageExt);this._loadImage(r)}}else if(this.config.images.length>0){this._startPreloader();var i=this;e.each(this.config.images,function(e){i._loadImage(e)})}}},_loadImage:function(t){var n=e("<img />").hide(),r=this;n.on("load",e.proxy(function(t){this.imageLoaded++;if(this.imageLoaded>=this.config.frames){console.log(this.imageLoaded);this._stopPreloader();e(this).trigger("allImagesLoaded")}},this));n.on("error",function(){console.error("couldn't load the image "+e(this).attr("src"))});n.attr({src:this.config.images[t],"class":String("turnable-img turnable-img-"+(t+1))})},_allImagesLoaded:function(){console.log("allImagesLoaded");this._createUI();this.config.onComplete(this)},_createUI:function(){this._createButtonWrapper();this.config.showSpinButton&&!this.config.step?this._createSpinButton():this.config.step&&this._createStepButtons();this.config.zoom&&this._createZoomButton();this.config.showInstruction&&this._createInstruction()},_createButtonWrapper:function(){this.$buttonWrapper=e("<div class='turnable-buttons'>");this.$wrapper.append(this.$buttonWrapper)},_createSpinButton:function(){var t=e("<a href='#turnable-spin' class='turnable-button turnable-spin-button'></a>").html(this.config.spinButtonContent);this.$buttonWrapper.append(t)},_createStepButtons:function(){var t=e("<div class='turnable-step-buttons'></div>"),n=e("<a href='#turnable-step-prev' class='turnable-button turnable-step-previous-button'></a>").html(this.config.previousButtonContent);n.appendTo(t);var r=e("<a href='#turnable-step-next' class='turnable-button turnable-step-next-button'></a>").html(this.config.nextButtonContent);r.appendTo(t);this.$buttonWrapper.append(t)},_createZoomButton:function(){var t=this.$elem.attr("src"),n=t.substr(0,t.lastIndexOf("."))+this.config.zoomSuffix+this.config.imageExt,r=e("<a href='"+n+"' target='_blank' class='turnable-button turnable-zoom-button'></a>").html(this.config.zoomButtonContent);r.appendTo(this.$buttonWrapper)},_createInstruction:function(){var t=e("<div class='turnable-instruction'></div>"),n=e("<div class='turnable-instruction-content'></div>"),r=e("<div class='turnable-instruction-content-inner'></div>").html(this.config.instructionContent);n.append(r);t.append(n);this.$wrapper.append(t)},_createZoom:function(t){this.$zoomLens=e("<div class='turnable-zoom-lens'></div>");this.touchDevice&&this.$zoomLens.addClass("turnable-touch");this.$zoomLens.appendTo(this.$wrapper)},_startPreloader:function(t){if(this.$wrapper.find(".turnable-overlay").length>0){this.$wrapper.find(".turnable-overlay").show();this.$wrapper.find(".turnable-loading-range").css({width:"0%"})}else{var n=e("<div class='turnable-overlay'></div>"),r=e("<div class='turnable-overlay-content'></div>"),i=e("<div class='turnable-loading-spinner'><p>Loading</p></div>");r.append(i);n.append(r);if(t){var s=e("<div class='turnable-loading-bar'><div class='turnable-loading-range'></div></div>");n.append(s)}this.$wrapper.prepend(n)}},_updatePreloader:function(e){this.$wrapper.find(".turnable-loading-range").css({width:e+"%"})},_stopPreloader:function(){this.$wrapper.find(".turnable-overlay").hide()},_spinButtonClicked:function(e){e.preventDefault();this.spin()},_zoomButtonClicked:function(e){if(!this.config.zoomAsLink){e.preventDefault();this.$wrapper.hasClass("turnable-zooming")?this.closeZoom():this.openZoom()}},_zoomLensClicked:function(){this.touchDevice||this.closeZoom()},_nextButtonClicked:function(e){e.preventDefault();this.nextImage()},_previousButtonClicked:function(e){e.preventDefault();this.previousImage()},_dragStarted:function(e){e.preventDefault();this.$wrapper.find(".turnable-instruction").hide();if(!this.$wrapper.hasClass("turnable-zooming")){if(e.originalEvent.touches&&e.originalEvent.touches.length){if(e.originalEvent.touches.length>1)return!0;e=e.originalEvent.touches[0]}else if(e.originalEvent.changedTouches&&e.originalEvent.changedTouches.length){if(e.originalEvent.changedTouches.length>1)return!0;e=e.originalEvent.changedTouches[0]}e.preventDefault&&e.preventDefault();var t=e.pageX;this.$wrapper.addClass("turnable-dragging");this.dragStartPosition=t;this.dragDistance=t}},_dragging:function(t){if(t.originalEvent.touches&&t.originalEvent.touches.length){if(t.originalEvent.touches.length>1){console.log("more than one touch");return!0}t=t.originalEvent.touches[0]}else if(t.originalEvent.changedTouches&&t.originalEvent.changedTouches.length){if(t.originalEvent.changedTouches.length>1){console.log("more than one touch 2");return!0}t=t.originalEvent.changedTouches[0]}if(this.$wrapper.hasClass("turnable-dragging")){e("body").css("cursor",this.config.cursor);t.preventDefault&&t.preventDefault();var n=t.pageX;if(n>this.dragDistance){var r=n-this.dragDistance;if(r>this.config.dragThreshold){var i=Math.floor(r/this.config.frames);i<1&&(i=1);this.dragDistance=n;this.nextImage(i)}}else if(n<this.dragDistance){var r=-n+this.dragDistance;if(r>this.config.dragThreshold){var i=Math.floor(r/this.config.frames);i<1&&(i=1);this.dragDistance=n;this.nextImage(-i)}}return!1}this.touchDevice&&this._updateZoomPosition(t)},_dragEnded:function(t){if(this.$wrapper.hasClass("turnable-dragging")){e("body").css("cursor","default");this.$wrapper.removeClass("turnable-dragging");this._updateZoomUrl()}},_moving:function(e){this._updateZoomPosition(e)},_entering:function(){if(this.$wrapper.hasClass("turnable-zooming")){this.$zoomLens.show();console.log(this.$zoomLens)}},_leaving:function(){if(this.$wrapper.hasClass("turnable-zooming")){this.$zoomLens.hide();console.log("leaving")}},_imageTouched:function(e){e.preventDefault()},_updateZoomUrl:function(){var e;if(this.config.zoomImages.length>0)e=this.config.zoomImages[this.currentImage];else{var t=this.config.images[this.currentImage];e=t.substr(0,t.lastIndexOf("."))+this.config.zoomSuffix+this.config.imageExt}this.$wrapper.find(".turnable-zoom-button").attr("href",e)},_loadZoomImage:function(){this._startPreloader();var t=this.$wrapper.find(".turnable-zoom-button").attr("href");this.$zoomImage=e("<img class='turnable-zoom-image' src='"+t+"' />");var n=this;this.$zoomImage.on("load",function(){n._stopPreloader();n.zoomWidthRatio=this.width/n.$elem.width();n.zoomHeightRatio=this.height/n.$elem.height();n.$zoomLens.css({backgroundImage:"url('"+t+"')"});n.$zoomLens.show()});this.$zoomImage.on("error",function(){console.log("File does not exists")})},_updateZoomPosition:function(e){if(this.$wrapper.hasClass("turnable-zooming")&&this.$zoomImage!==null){var t=this.$elem.offset(),n=parseInt(e.pageX-t.left),r=parseInt(e.pageY-t.top);if(!this.touchDevice&&e.pageX>t.left+this.$elem.width()||e.pageX<t.left||e.pageY>t.top+this.$elem.height()||e.pageY<t.top){this._leaving();return!0}var i=(n*this.zoomWidthRatio-this.$zoomLens.width()/2)*-1,s=(r*this.zoomHeightRatio-this.$zoomLens.height()/2)*-1;if(this.touchDevice){n+=104;r-=104}this.$zoomLens.css({backgroundPosition:i+"px "+s+"px"});this.$zoomLens.css({left:n-this.$zoomLens.width()/2+"px",top:r-this.$zoomLens.height()/2+"px"})}},spin:function(e){if(!this.$wrapper.hasClass("turnable-spinning")&&!this.$wrapper.hasClass("turnable-zooming")){var t=this.config.spinSpeed/this.config.frames,n=this.currentImage,r=this,i=window.setInterval(function(){r.$wrapper.hasClass("turnable-spinning-backwards")?r.previousImage():r.nextImage();if(r.config.wrapAround&&r.currentImage===n){clearInterval(i);r.$wrapper.removeClass("turnable-spinning")}else if(!r.config.wrapAround&&r.currentImage===r.config.frames-1)r.$wrapper.addClass("turnable-spinning-backwards");else if(r.currentImage===0&&!r.config.wrapAround&&r.$wrapper.hasClass("turnable-spinning-backwards")){clearInterval(i);r.$wrapper.removeClass("turnable-spinning");r.$wrapper.removeClass("turnable-spinning-backwards")}},t);this.$wrapper.addClass("turnable-spinning")}},previousImage:function(e){typeof e=="undefined"&&(e=1);this.nextImage(-e)},nextImage:function(e){typeof e=="undefined"&&(e=1);this.currentImage+=e;this.currentImage>=this.config.frames?this.config.wrapAround?this.currentImage=0:this.currentImage=this.config.frames-1:this.currentImage<0&&(this.config.wrapAround?this.currentImage=this.config.frames-1:this.currentImage=0);this.$elem.attr("src",this.config.images[this.currentImage])},openZoom:function(){this.$zoomLens===null&&this._createZoom();this.$wrapper.addClass("turnable-zooming");this.$wrapper.find(".turnable-zoom-button").addClass("turnable-active");this._loadZoomImage()},closeZoom:function(){this.$zoomLens!==null&&this.$zoomLens.hide();this.$wrapper.removeClass("turnable-zooming");this.$wrapper.find(".turnable-zoom-button").removeClass("turnable-active")}};t.defaults=t.prototype.defaults;e.fn.turnable=function(e){var n=this;return this.each(function(){var r=new t(this,e);r.init();n.methods=r})}})(jQuery);