!function(a){"use strict";var b=function(b,c){this.elem=b,this.$elem=a(b),this.options=c,this.metadata=this.$elem.data("turnable-options"),this.spinTo=function(){}};b.prototype={touchDevice:!1,$zoomLens:null,$wrapper:null,$elem:null,startDragPosition:0,dragDistance:0,currentImage:0,defaults:{catwalk:!1,cursor:"col-resize",dragThreshold:10,frames:38,imageExt:".jpg",images:[],showSpinButton:!0,wrapAround:!0,singleImage:!1,showInstruction:!0,instructionContent:"<p> &lt; Drag to spin &gt; </p>",spinButtonContent:"spin",zoomButtonContent:"zoom",nextButtonContent:"next",previousButtonContent:"previous",step:!1,spinSpeed:1500,zoom:!1,zoomAsLink:!1,zoomSuffix:"_big",zoomImages:[],onComplete:function(){}},init:function(){return this.config=a.extend({},this.defaults,this.options,this.metadata),this.config.images.length>0&&(this.config.frames=this.config.images.length),this._readPropertiesFromClasses(),this._checkForTouchDevice(),this._createWrapper(),this._initEvents(),this._loadImages(),this},events:{"click .turnable-spin-button":"_spinButtonClicked","click .turnable-step-previous-button":"_previousButtonClicked","click .turnable-step-next-button":"_nextButtonClicked","click .turnable-zoom-button":"_zoomButtonClicked","click .turnable-zoom-lens":"_zoomLensClicked","touchstart img":"_imageTouched",mouseenter:"_entering",mouseleave:"_leaving",mousedown:"_dragStarted","mousemove document":"_dragging",mousemove:"_moving",touchstart:"_dragStarted","touchmove document":"_dragging",touchend:"_dragEnded","mouseup document":"_dragEnded"},internalEvents:{allImagesLoaded:"_allImagesLoaded"},_initEvents:function(){var b=this;this.touchDevice="ontouchstart"in document.documentElement,a.each(this.internalEvents,function(c,d){a(b).on(c,a.proxy(b,d))}),a.each(this.events,function(c,d){var e=c.split(" "),f=e[0];if(e.length>1){var g=e[1];"document"===g?a(document).on(f,a.proxy(b,d)):b.$wrapper.on(f,g,a.proxy(b,d))}else b.$wrapper.on(f,a.proxy(b,d))})},_readPropertiesFromClasses:function(){var a=this.$elem.attr("class");if(a){var b=a.match(/frames=(\d[\d]*)/g);if(b){var c=String(b),d=c.match(/(\d[\d]*)/g);d&&(this.config.frames=parseInt(c.match(/(\d[\d]*)/g),10))}}this.$elem.hasClass("zoom")&&(this.config.zoom=!0),(this.$elem.hasClass("moving-still")||this.$elem.hasClass("nowrap"))&&(this.config.wrapAround=!1),this.$elem.hasClass("catwalk")&&(this.config.catwalk=!0,this.config.spinSpeed=3e3),this.$elem.hasClass("nospin")&&(this.config.showSpinButton=!1)},_checkForTouchDevice:function(){"ontouchstart"in window&&(this.touchDevice=!0)},_createWrapper:function(){if(this.$elem.is("img")){var b=a("<div></div>").attr("class","turnable-wrapper");b.css({width:this.$elem.width(),height:this.$elem.height(),cursor:this.config.cursor}),this.$elem.wrap(b),this.$wrapper=this.$elem.parent(".turnable-wrapper")}else if(this.$wrapper=this.$elem.addClass("turnable-wrapper"),this.config.images.length>0){this.$elem=a("<img/>"),this.$wrapper.append(this.$elem);var c=this;this.$elem.on("load",function(){c.$wrapper.css({width:c.$elem.width(),height:c.$elem.height(),cursor:c.config.cursor})}),this.$elem.attr("src",this.config.images[0])}},_loadImages:function(){if(!this.config.singleImage)if(this.imageLoaded=0,this.$elem.is("img")){this._startPreloader();for(var b=this.$elem.attr("src"),c=b.substr(0,b.lastIndexOf("-")+1),d=0;d<this.config.frames;d+=1)9>d?this.config.images.push(c+"0"+(d+1).toString()+this.config.imageExt):this.config.images.push(c+(d+1).toString()+this.config.imageExt),this._loadImage(d)}else if(this.config.images.length>0){this._startPreloader();var e=this;a.each(this.config.images,function(a){e._loadImage(a)})}},_loadImage:function(b){var c=a("<img />").hide();c.on("load",a.proxy(function(){this.imageLoaded++,this.imageLoaded>=this.config.frames&&(this._stopPreloader(),a(this).trigger("allImagesLoaded"))},this)),c.on("error",function(){console.error("couldn't load the image "+a(this).attr("src"))}),c.attr({src:this.config.images[b],"class":"turnable-img turnable-img-"+(b+1)})},_allImagesLoaded:function(){this._createUI(),this.config.onComplete(this)},_createUI:function(){this._createButtonWrapper(),this.config.showSpinButton&&!this.config.step?this._createSpinButton():this.config.step&&this._createStepButtons(),this.config.zoom&&this._createZoomButton(),this.config.showInstruction&&this._createInstruction()},_createButtonWrapper:function(){this.$buttonWrapper=a("<div class='turnable-buttons'>"),this.$wrapper.append(this.$buttonWrapper)},_createSpinButton:function(){var b=a("<a href='#turnable-spin' class='turnable-button turnable-spin-button'></a>").html(this.config.spinButtonContent);this.$buttonWrapper.append(b)},_createStepButtons:function(){var b=a("<div class='turnable-step-buttons'></div>"),c=a("<a href='#turnable-step-prev' class='turnable-button turnable-step-previous-button'></a>").html(this.config.previousButtonContent);c.appendTo(b);var d=a("<a href='#turnable-step-next' class='turnable-button turnable-step-next-button'></a>").html(this.config.nextButtonContent);d.appendTo(b),this.$buttonWrapper.append(b)},_createZoomButton:function(){var b=this.$elem.attr("src"),c=b.substr(0,b.lastIndexOf("."))+this.config.zoomSuffix+this.config.imageExt,d=a("<a href='"+c+"' target='_blank' class='turnable-button turnable-zoom-button'></a>").html(this.config.zoomButtonContent);d.appendTo(this.$buttonWrapper)},_createInstruction:function(){var b=a("<div class='turnable-instruction'></div>"),c=a("<div class='turnable-instruction-content'></div>"),d=a("<div class='turnable-instruction-content-inner'></div>").html(this.config.instructionContent);c.append(d),b.append(c),this.$wrapper.append(b)},_createZoom:function(){this.$zoomLens=a("<div class='turnable-zoom-lens'></div>"),this.touchDevice&&this.$zoomLens.addClass("turnable-touch"),this.$zoomLens.appendTo(this.$wrapper)},_startPreloader:function(b){if(this.$wrapper.find(".turnable-overlay").length>0)this.$wrapper.find(".turnable-overlay").show(),this.$wrapper.find(".turnable-loading-range").css({width:"0%"});else{var c=a("<div class='turnable-overlay'></div>"),d=a("<div class='turnable-overlay-content'></div>"),e=a("<div class='turnable-loading-spinner'><p>Loading</p></div>");if(d.append(e),c.append(d),b){var f=a("<div class='turnable-loading-bar'><div class='turnable-loading-range'></div></div>");c.append(f)}this.$wrapper.prepend(c)}},_updatePreloader:function(a){this.$wrapper.find(".turnable-loading-range").css({width:a+"%"})},_stopPreloader:function(){this.$wrapper.find(".turnable-overlay").hide()},_spinButtonClicked:function(a){a.preventDefault(),this.spin()},_zoomButtonClicked:function(a){this.config.zoomAsLink||(a.preventDefault(),this.$wrapper.hasClass("turnable-zooming")?this.closeZoom():this.openZoom())},_zoomLensClicked:function(){this.touchDevice||this.closeZoom()},_nextButtonClicked:function(a){a.preventDefault(),this.nextImage()},_previousButtonClicked:function(a){a.preventDefault(),this.previousImage()},_dragStarted:function(a){if(a.preventDefault(),this.$wrapper.find(".turnable-instruction").hide(),!this.$wrapper.hasClass("turnable-zooming")){if(a.originalEvent.touches&&a.originalEvent.touches.length){if(a.originalEvent.touches.length>1)return!0;a=a.originalEvent.touches[0]}else if(a.originalEvent.changedTouches&&a.originalEvent.changedTouches.length){if(a.originalEvent.changedTouches.length>1)return!0;a=a.originalEvent.changedTouches[0]}a.preventDefault&&a.preventDefault();var b=a.pageX;this.$wrapper.addClass("turnable-dragging"),this.dragStartPosition=b,this.dragDistance=b}},_dragging:function(b){if(b.originalEvent.touches&&b.originalEvent.touches.length){if(b.originalEvent.touches.length>1)return!0;b=b.originalEvent.touches[0]}else if(b.originalEvent.changedTouches&&b.originalEvent.changedTouches.length){if(b.originalEvent.changedTouches.length>1)return!0;b=b.originalEvent.changedTouches[0]}if(this.$wrapper.hasClass("turnable-dragging")){a("body").css("cursor",this.config.cursor),b.preventDefault&&b.preventDefault();var c=b.pageX,d=0,e=0;return c>this.dragDistance?(d=c-this.dragDistance,d>this.config.dragThreshold&&(e=Math.floor(d/this.config.frames),1>e&&(e=1),this.dragDistance=c,this.nextImage(e))):c<this.dragDistance&&(d=-c+this.dragDistance,d>this.config.dragThreshold&&(e=Math.floor(d/this.config.frames),1>e&&(e=1),this.dragDistance=c,this.nextImage(-e))),!1}this.touchDevice&&this._updateZoomPosition(b)},_dragEnded:function(){this.$wrapper.hasClass("turnable-dragging")&&(a("body").css("cursor","default"),this.$wrapper.removeClass("turnable-dragging"),this._updateZoomUrl())},_moving:function(a){this._updateZoomPosition(a)},_entering:function(){this.$wrapper.hasClass("turnable-zooming")&&this.$zoomLens.show()},_leaving:function(){this.$wrapper.hasClass("turnable-zooming")&&this.$zoomLens.hide()},_imageTouched:function(a){a.preventDefault()},_updateZoomUrl:function(){var a;if(this.config.zoomImages.length>0)a=this.config.zoomImages[this.currentImage];else{var b=this.config.images[this.currentImage];a=b.substr(0,b.lastIndexOf("."))+this.config.zoomSuffix+this.config.imageExt}this.$wrapper.find(".turnable-zoom-button").attr("href",a)},_loadZoomImage:function(){this._startPreloader();var b=this.$wrapper.find(".turnable-zoom-button").attr("href");this.$zoomImage=a("<img class='turnable-zoom-image' src='"+b+"' />");var c=this;this.$zoomImage.on("load",function(){c._stopPreloader(),c.zoomWidthRatio=this.width/c.$elem.width(),c.zoomHeightRatio=this.height/c.$elem.height(),c.$zoomLens.css({backgroundImage:"url('"+b+"')"}),c.$zoomLens.show()}),this.$zoomImage.on("error",function(){})},_updateZoomPosition:function(a){if(this.$wrapper.hasClass("turnable-zooming")&&null!==this.$zoomImage){var b=this.$elem.offset(),c=parseInt(a.pageX-b.left,10),d=parseInt(a.pageY-b.top,10);if(!this.touchDevice&&a.pageX>b.left+this.$elem.width()||a.pageX<b.left||a.pageY>b.top+this.$elem.height()||a.pageY<b.top)return this._leaving(),!0;var e=-1*(c*this.zoomWidthRatio-this.$zoomLens.width()/2),f=-1*(d*this.zoomHeightRatio-this.$zoomLens.height()/2);this.touchDevice&&(c+=104,d-=104),this.$zoomLens.css({backgroundPosition:e+"px "+f+"px"}),this.$zoomLens.css({left:c-this.$zoomLens.width()/2+"px",top:d-this.$zoomLens.height()/2+"px"})}},spin:function(){if(!this.$wrapper.hasClass("turnable-spinning")&&!this.$wrapper.hasClass("turnable-zooming")){var a=this.config.spinSpeed/this.config.frames,b=this.currentImage,c=this,d=window.setInterval(function(){c.$wrapper.hasClass("turnable-spinning-backwards")?c.previousImage():c.nextImage(),c.config.wrapAround&&c.currentImage===b?(clearInterval(d),c.$wrapper.removeClass("turnable-spinning")):c.config.wrapAround||c.currentImage!==c.config.frames-1?0===c.currentImage&&!c.config.wrapAround&&c.$wrapper.hasClass("turnable-spinning-backwards")&&(clearInterval(d),c.$wrapper.removeClass("turnable-spinning"),c.$wrapper.removeClass("turnable-spinning-backwards")):c.$wrapper.addClass("turnable-spinning-backwards")},a);this.$wrapper.addClass("turnable-spinning")}},previousImage:function(a){"undefined"==typeof a&&(a=1),this.nextImage(-a)},nextImage:function(a){"undefined"==typeof a&&(a=1),this.currentImage+=a,this.checkImageBounds(),this.$elem.attr("src",this.config.images[this.currentImage])},checkImageBounds:function(){this.currentImage>=this.config.frames?this.currentImage=this.config.wrapAround?0:this.config.frames-1:this.currentImage<0&&(this.currentImage=this.config.wrapAround?this.config.frames-1:0)},openZoom:function(){null===this.$zoomLens&&this._createZoom(),this.$wrapper.addClass("turnable-zooming"),this.$wrapper.find(".turnable-zoom-button").addClass("turnable-active"),this._loadZoomImage()},closeZoom:function(){null!==this.$zoomLens&&this.$zoomLens.hide(),this.$wrapper.removeClass("turnable-zooming"),this.$wrapper.find(".turnable-zoom-button").removeClass("turnable-active")},setImage:function(a){this.currentImage=a,this.checkImageBounds(),this.$elem.attr("src",this.config.images[this.currentImage])}},b.defaults=b.prototype.defaults,a.fn.turnable=function(c,d){return"string"==typeof c?this.each(function(){var b=a(this).data("turnable");b[c](d)}):this.each(function(){var d=new b(this,c);a(this).data("turnable",d),d.init()})}}(jQuery);